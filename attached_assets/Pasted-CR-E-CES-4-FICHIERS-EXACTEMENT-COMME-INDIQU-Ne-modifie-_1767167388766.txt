CR√âE CES 4 FICHIERS EXACTEMENT COMME INDIQU√â. Ne modifie rien, copie tel quel.

==========================================
FICHIER 1: server/config.ts
==========================================

/**
 * NEUROCORE 360 - Configuration centralis√©e
 */

export const CONFIG = {
  // Gemini API
  GEMINI_API_KEY: process.env.GEMINI_API_KEY || "AIzaSyCYpRQifyhMTFu-q0dihbomcOdB0eaogc4",
  GEMINI_MODEL: "gemini-3-pro-preview",
  GEMINI_TEMPERATURE: 0.85,
  GEMINI_MAX_TOKENS: 8000,
  GEMINI_MAX_RETRIES: 3,
  GEMINI_SLEEP_BETWEEN: 5,

  // Server
  PORT: process.env.PORT || 3000,
  NODE_ENV: process.env.NODE_ENV || 'development',
};

// Tiers d'audit
export const AUDIT_TIERS = {
  FREE: {
    name: 'Gratuit',
    price: 0,
    sectionsUnlocked: [
      'Introduction',
      'Moment R√©v√©lation',
      'Cause Racine en 3 phrases',
      'Radar Profil actuel et Profil optimis√©'
    ],
    sectionsTeaser: [
      'Analyse visuelle photo face et dos',
      'Nutrition & m√©tabolisme',
      'Sommeil & biohacking',
      'Axes hormonaux & bilans',
      'Feuille de Route en 6 Points',
      'Projection 30/60/90 jours'
    ],
    sectionsLocked: [
      'Sangle profonde / posture lombaires',
      'Analyse entra√Ænement',
      'Cardio',
      'Digestion & tol√©rances',
      'Ton Potentiel Inexploit√©',
      'Ce qui va changer si on travaille ensemble',
      'R√©assurance √©motionnelle',
      'Synth√®se clinique globale et Conclusion transformationnelle'
    ]
  },
  PREMIUM: {
    name: 'Premium',
    price: 49,
    sectionsUnlocked: 'ALL'
  },
  ELITE: {
    name: 'Elite',
    price: 149,
    sectionsUnlocked: 'ALL',
    extras: ['Appel 30min', 'Suivi 7 jours', 'Plan personnalis√© PDF']
  }
};


==========================================
FICHIER 2: server/types.ts
==========================================

/**
 * NEUROCORE 360 - Types TypeScript
 */

export type AuditTier = 'FREE' | 'PREMIUM' | 'ELITE';

export interface ClientData {
  // Profil
  prenom?: string;
  nom?: string;
  age?: string;
  sexe?: string;
  taille?: string;
  poids?: string;
  objectif?: string;
  'type-travail'?: string;
  'niveau-activite'?: string;
  'antecedents-medicaux'?: string[];
  medicaments?: string;
  allergies?: string[];

  // Composition
  'tour-taille'?: string;
  'tour-hanches'?: string;
  'masse-grasse'?: string;
  'objectif-poids'?: string;
  'evolution-poids'?: string;
  morphologie?: string;
  'zones-stockage'?: string[];
  'retention-eau'?: string;
  cellulite?: string;

  // M√©tabolisme
  'energie-matin'?: string;
  'energie-apres-midi'?: string;
  'energie-soir'?: string;
  'coups-fatigue'?: string;
  'heure-fatigue'?: string;
  frilosite?: string;
  transpiration?: string;
  metabolisme?: string;
  'envies-sucre'?: string;
  'frequence-faim'?: string;

  // Nutrition
  'nb-repas'?: string;
  'petit-dejeuner'?: string;
  'type-petit-dejeuner'?: string;
  'tracking-calories'?: string;
  'estimation-calories'?: string;
  'proteines-jour'?: string;
  'eau-jour'?: string;
  'regime-particulier'?: string;
  supplements?: string[];
  'repas-exterieur'?: string;

  // Digestion
  'qualite-digestion'?: string;
  ballonnements?: string;
  transit?: string;
  reflux?: string;
  intolerances?: string[];
  probiotiques?: string;
  'aliments-fermentes'?: string;
  antibiotiques?: string;
  selles?: string;
  'douleurs-abdominales'?: string;

  // Activit√©
  'frequence-sport'?: string;
  'types-activites'?: string[];
  'duree-seance'?: string;
  'intensite-entrainement'?: string;
  'qualite-recuperation'?: string;
  courbatures?: string;
  'evolution-performances'?: string;
  blessures?: string[];
  echauffement?: string;
  etirements?: string;

  // Sommeil
  'heures-sommeil'?: string;
  'qualite-sommeil'?: string;
  'heure-coucher'?: string;
  'heure-lever'?: string;
  'temps-endormissement'?: string;
  'reveils-nuit'?: string;
  'repos-reveil'?: string;
  sieste?: string;
  'ecrans-avant-dormir'?: string;
  'temperature-chambre'?: string;

  // HRV Cardiaque
  'mesure-hrv'?: string;
  'hrv-moyenne'?: string;
  'fc-repos'?: string;
  'tension-arterielle'?: string;
  'montre-connectee'?: string;
  'type-montre'?: string;
  palpitations?: string;
  essoufflement?: string;

  // Biomarqueurs
  'bilan-sanguin'?: string;
  glycemie?: string;
  cholesterol?: string;
  'vitamine-d'?: string;
  'fer-ferritine'?: string;
  thyroide?: string;
  testosterone?: string;
  inflammation?: string;
  'marqueurs-hepatiques'?: string;
  'marqueurs-renaux'?: string;

  // Hormones Stress
  'niveau-stress'?: string;
  'sources-stress'?: string[];
  'gestion-stress'?: string[];
  anxiete?: string;
  'fluctuation-humeurs'?: string;
  libido?: string;
  'symptomes-cortisol'?: string[];
  'symptomes-thyroidiens'?: string[];
  'cycle-menstruel'?: string;
  motivation?: string;

  // Lifestyle
  'cafes-jour'?: string;
  'heure-dernier-cafe'?: string;
  'alcool-semaine'?: string;
  tabac?: string;
  cannabis?: string;
  'temps-ecran'?: string;
  'exposition-soleil'?: string;
  'temps-nature'?: string;
  meditation?: string;
  'douches-froides'?: string;

  // Biom√©canique
  'douleurs-chroniques'?: string[];
  'posture-travail'?: string;
  'heures-assis'?: string;
  mobilite?: string;
  'squat-complet'?: string;
  'toucher-orteils'?: string;
  asymetries?: string;
  'travail-mobilite'?: string;
  'foam-roller'?: string;
  'kine-osteo'?: string;

  // Psychologie
  tca?: string;
  'type-tca'?: string[];
  'relation-nourriture'?: string;
  'episodes-depressifs'?: string;
  'symptomes-psy'?: string[];
  traumatismes?: string;
  'impact-traumatismes'?: string;
  'estime-soi'?: string;
  'motivation-profonde'?: string;
  modele?: string;
  blocages?: string[];
  soutien?: string;
  'suivi-psy'?: string;
  'objectif-transformation'?: string;

  // Neuro
  concentration?: string;
  memoire?: string;
  'brouillard-mental'?: string;
  humeur?: string;
  procrastination?: string;
  impulsivite?: string;
  creativite?: string;
  apprentissage?: string;

  [key: string]: any;
}

export interface PhotoAnalysis {
  available: boolean;
  fatDistribution?: {
    pattern: 'androide' | 'gynoide' | 'mixte';
    zones: string[];
    severity: 'legere' | 'moderee' | 'importante';
  };
  muscleBalance?: {
    hautCorps: number;
    basCorps: number;
    symmetrie: number;
    groupesAvance: string[];
    groupesRetard: string[];
  };
  postureIssues?: {
    epaules: string;
    bassin: string;
    colonne: string;
    asymetries: string[];
  };
  structureOsseuse?: {
    largeurEpaules: string;
    cageThoracique: string;
    ratioEpaulesTaille: string;
  };
}

export interface AuditSection {
  id: string;
  title: string;
  content: string;
  score?: number;
  isUnlocked: boolean;
  isTeaser: boolean;
  teaserPreview?: string;
}

export interface AuditResult {
  success: boolean;
  tier: AuditTier;
  sections: AuditSection[];
  fullTxt?: string;
  clientName?: string;
  globalScore?: number;
  error?: string;
  metadata?: {
    generationTimeMs: number;
    sectionsGenerated: number;
    modelUsed: string;
  };
}

export type SectionName =
  | "Introduction"
  | "Analyse visuelle photo face et dos"
  | "Sangle profonde / posture lombaires"
  | "Analyse entra√Ænement"
  | "Cardio"
  | "Nutrition & m√©tabolisme"
  | "Sommeil & biohacking"
  | "Digestion & tol√©rances"
  | "Axes hormonaux & bilans"
  | "Moment R√©v√©lation"
  | "Cause Racine en 3 phrases"
  | "Radar Profil actuel et Profil optimis√©"
  | "Ton Potentiel Inexploit√©"
  | "Feuille de Route en 6 Points"
  | "Projection 30/60/90 jours"
  | "Ce qui va changer si on travaille ensemble"
  | "R√©assurance √©motionnelle"
  | "Synth√®se clinique globale et Conclusion transformationnelle";


==========================================
FICHIER 3: server/geminiPremiumEngine.ts
==========================================

/**
 * NEUROCORE 360 - Moteur de g√©n√©ration Gemini
 * Syst√®me d'audit PREMIUM avec version FREE (teasing) et PAID (complet)
 */

import { GoogleGenerativeAI } from '@google/generative-ai';
import { CONFIG, AUDIT_TIERS } from './config';
import { ClientData, PhotoAnalysis, AuditResult, AuditSection, SectionName, AuditTier } from './types';

const genAI = new GoogleGenerativeAI(CONFIG.GEMINI_API_KEY);

// ============================================================
// SECTIONS DE L'AUDIT
// ============================================================
const SECTIONS: SectionName[] = [
  "Introduction",
  "Analyse visuelle photo face et dos",
  "Sangle profonde / posture lombaires",
  "Analyse entra√Ænement",
  "Cardio",
  "Nutrition & m√©tabolisme",
  "Sommeil & biohacking",
  "Digestion & tol√©rances",
  "Axes hormonaux & bilans",
  "Moment R√©v√©lation",
  "Cause Racine en 3 phrases",
  "Radar Profil actuel et Profil optimis√©",
  "Ton Potentiel Inexploit√©",
  "Feuille de Route en 6 Points",
  "Projection 30/60/90 jours",
  "Ce qui va changer si on travaille ensemble",
  "R√©assurance √©motionnelle",
  "Synth√®se clinique globale et Conclusion transformationnelle"
];

// ============================================================
// PROMPT MA√éTRE
// ============================================================
const PROMPT_SECTION = `Tu es Achzod, coach sportif d'√©lite avec 11 certifications internationales, expert en biom√©canique, nutrition, hormones, pr√©paration physique et biohacking.

Tu r√©diges un audit expert 100% personnalis√©, profond√©ment humain, ind√©tectable comme IA, avec un ton direct, pr√©cis, incarn√©, analytique et ultra vivant.

Section √† r√©diger : {section}

üî• R√àGLES ABSOLUES :

Style :
- Humain, jamais robotique ou scolaire
- Variation de rythmes : phrases courtes/longues, pauses..., asides, m√©taphores simples
- Style conversationnel expert : proximit√© + exigence
- Tu tutoies toujours
- Chaud, direct, incarn√© comme si tu parlais face √† face
- Analyse chirurgicale mais accessible
- Images concr√®tes, pas de jargon inutile

Contenu :
- NE JAMAIS INVENTER : analyse uniquement ce que le client a vraiment dit, montr√© ou laiss√© entendre
- Connecte TOUT : sommeil ‚Üî cortisol ‚Üî entra√Ænement ‚Üî plateaux ‚Üî digestion ‚Üî √©nergie ‚Üî stress ‚Üî biom√©canique
- Explique SCIENTIFIQUEMENT ET EN PROFONDEUR :
  * Les m√©canismes physiologiques pr√©cis (hormones, enzymes, neurotransmetteurs, cascades m√©taboliques)
  * Les chiffres, ratios, seuils cliniques quand pertinent
  * Les interactions complexes entre syst√®mes (thyro√Øde ‚Üî cortisol ‚Üî leptine ‚Üî insuline)
  * Les adaptations m√©taboliques (downregulation, upregulation, sensibilit√© r√©ceptorielle)
  * Les cascades de cons√©quences (cause ‚Üí effet 1 ‚Üí effet 2 ‚Üí effet 3 ‚Üí plateau actuel)
- Pr√©cise toujours : forces / blocages / risques futurs / √† recadrer / √† optimiser / m√©canismes sous-jacents
- TR√àS long, riche, d√©taill√©, scientifiquement robuste - minimum 40-50 lignes par section analytique
- Comme si tu avais pass√© 3h √† d√©cortiquer son dossier avec des marqueurs et des notes partout

Scoring (pour sections d'analyse classiques uniquement) :
- Format obligatoire : "Score : X/10" sur une ligne s√©par√©e
- Sections AVEC score : Introduction, Analyse visuelle, Sangle profonde, Analyse entra√Ænement, Cardio, Nutrition, Sommeil, Digestion, Axes hormonaux, Synth√®se
- Sections SANS score : Moment R√©v√©lation, Cause Racine, Radar Profil, Potentiel Inexploit√©, Feuille de Route, Projection, Ce qui va changer, R√©assurance
- Jamais de score invent√©, toujours bas√© sur les vraies donn√©es

Format :
- Texte brut (pas de HTML, PAS DE MARKDOWN DU TOUT - pas de **, pas de ##, pas de _, pas de *)
- NE JAMAIS r√©p√©ter le titre de la section au d√©but du contenu (commencer DIRECTEMENT par l'analyse)
- Minimum 40-50 lignes pour les sections d'analyse
- Utiliser des graphiques ASCII TR√àS visuels pour illustrer les points cl√©s
- JAMAIS de formatage markdown - juste du texte brut descriptif et fluide

üìä R√àGLES GRAPHIQUES ASCII OBLIGATOIRES :
- Chaque graphique doit √™tre sur PLUSIEURS lignes s√©par√©es
- Toujours pr√©c√©der un graphique d'une ligne vide
- Format pour les jauges :

  Nom de la m√©trique : [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°] 6/10

- Format pour les listes visuelles :

  ‚úì Point positif explicite
  ‚úó Point n√©gatif explicite
  ‚Üí Action √† prendre

- NE JAMAIS mettre les graphiques dans une phrase continue
- Les graphiques doivent √™tre VISUELLEMENT s√©par√©s du texte

‚ö†Ô∏è L'objectif : que le client ait l'impression que le vrai Achzod a regard√© ses photos, connu son quotidien, compris la personne derri√®re les r√©ponses.

{section_specific_instructions}

Donn√©es du client :
{data}
`;

// ============================================================
// INSTRUCTIONS SP√âCIFIQUES PAR SECTION
// ============================================================
const SECTION_INSTRUCTIONS: Record<string, string> = {
  "Introduction": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "INTRODUCTION" :
- Accroche PUISSANTE d√®s la premi√®re ligne - le client doit se sentir vu, compris
- R√©sume son profil de mani√®re personnalis√©e (√¢ge, stats, objectifs, situation)
- Identifie le PARADOXE de sa situation (pourquoi il bloque malgr√© ses efforts)
- Cr√©e une connexion √©motionnelle tout en montrant ton expertise
- Annonce ce que l'audit va r√©v√©ler
- Minimum 35-40 lignes, ton chaud et direct
- Score √† la fin bas√© sur la qualit√© globale du profil initial
`,

  "Analyse visuelle photo face et dos": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "ANALYSE VISUELLE" :

‚ö†Ô∏è SI AUCUNE PHOTO FOURNIE : Commence par "Analyse visuelle non disponible - aucune photo fournie." puis d√©cris ce que tu AURAIS analys√© et pourquoi c'est important. Termine par une incitation √† uploader des photos pour un audit complet. (15-20 lignes max)

SI PHOTOS DISPONIBLES :
- Analyse la STRUCTURE : clavicules, cage thoracique, largeur d'√©paules, ratio √©paules/taille
- Analyse le D√âVELOPPEMENT MUSCULAIRE : quels groupes sont en avance, en retard, asym√©tries
- Analyse la COMPOSITION CORPORELLE : estimation du taux de gras, pattern de stockage (abdominal, obliques, etc.)
- Analyse la POSTURE visible : √©paules en avant, bassin, colonne
- INTERPR√àTE ce que √ßa signifie pour son m√©tabolisme et ses hormones
- Relie le pattern de stockage aux hypoth√®ses hormonales (cortisol, insuline, ≈ìstrog√®nes)
- Minimum 45-50 lignes tr√®s d√©taill√©es
- Donne un score bas√© sur le d√©veloppement musculaire et la composition
`,

  "Sangle profonde / posture lombaires": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "SANGLE PROFONDE / POSTURE" :
- Analyse l'impact de son historique sportif sur sa posture
- Explique le r√¥le du TRANSVERSE ABDOMINAL vs grand droit
- D√©tecte les signes d'ant√©version/r√©troversion pelvienne
- Explique les CASCADES : psoas raccourci ‚Üí lordose ‚Üí compression diaphragme ‚Üí respiration superficielle ‚Üí cortisol ‚Üí stockage
- Lie la posture √† l'esth√©tique abdominale (ventre qui ressort m√™me sans gras)
- Propose des hypoth√®ses sur les fl√©chisseurs de hanche, fessiers endormis
- Minimum 40-45 lignes avec explications biom√©caniques
- Score bas√© sur la qualit√© posturale estim√©e
`,

  "Analyse entra√Ænement": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "ANALYSE ENTRA√éNEMENT" :
- Analyse son SPLIT actuel (volume, fr√©quence, type)
- Identifie les ERREURS probables : tempo non contr√¥l√©, pas de p√©riodisation, m√™me routine depuis trop longtemps
- Explique l'ADAPTATION NEURALE et pourquoi le corps ne r√©pond plus
- Parle de stress m√©canique vs stress m√©tabolique
- Analyse le ratio Push/Pull et les d√©s√©quilibres potentiels
- Propose des hypoth√®ses sur ce qui manque : techniques d'intensification, variations, p√©riodisation en blocs
- Minimum 45-50 lignes tr√®s techniques
- Score bas√© sur la qualit√© du programme actuel
`,

  "Cardio": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "CARDIO" :
- Analyse sa pratique cardio actuelle (ou son absence)
- Explique ce que le cardio apporte VRAIMENT : sensibilit√© insuline, biogen√®se mitochondriale, flexibilit√© m√©tabolique
- Diff√©rencie LISS, HIIT, NEAT et leurs effets
- Calcule son TDEE estim√© avec son activit√© professionnelle
- Explique pourquoi le cardio n'est pas l'ennemi de la masse musculaire (bien dos√©)
- Recommandations pr√©cises : type, dur√©e, fr√©quence, timing
- Minimum 40-45 lignes
- Score bas√© sur l'optimisation de son activit√© cardio
`,

  "Nutrition & m√©tabolisme": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "NUTRITION & M√âTABOLISME" :
- Analyse PR√âCIS√âMENT ce qu'il mange (selon ses r√©ponses)
- Calcule ses BESOINS : BMR, TDEE, macros optimaux (prot√©ines, glucides, lipides)
- Identifie les ERREURS de timing : glucides au mauvais moment, fen√™tre anabolique rat√©e
- Explique le CARB CYCLING et pourquoi c'est pertinent pour lui
- Analyse sa suppl√©mentation actuelle et ce qui manque (om√©ga-3, etc.)
- Parle de sensibilit√© √† l'insuline, partitionnement des nutriments
- Minimum 50-60 lignes TR√àS d√©taill√©es avec chiffres
- Score bas√© sur la qualit√© nutritionnelle actuelle
`,

  "Sommeil & biohacking": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "SOMMEIL & BIOHACKING" :
- Analyse sa qualit√© de sommeil (dur√©e, r√©veils, qualit√©)
- Explique le r√¥le de la GH pendant le sommeil profond (phases N3)
- Parle des cycles de 90 min et de l'importance du nombre de cycles
- Si r√©veils nocturnes : hypoth√®ses (cortisol, hypoglyc√©mie, environnement)
- Analyse sa prise de m√©latonine si applicable (dosage, cycling)
- Propose des "hacks" simples mais efficaces : lumi√®re matinale, temp√©rature, √©crans
- Lie sommeil et r√©cup√©ration musculaire / hormones
- Minimum 40-45 lignes
- Score bas√© sur la qualit√© du sommeil
`,

  "Digestion & tol√©rances": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "DIGESTION & TOL√âRANCES" :
- Analyse son transit (rapide/lent) et ce que √ßa signifie
- Si ballonnements : hypoth√®ses sur les causes (FODMAPs, lactose, fibres, prot√©ines mal dig√©r√©es)
- Analyse l'impact de la caf√©ine sur la digestion
- Parle du microbiote et de son r√¥le
- Analyse ses probiotiques s'il en prend
- Propose des solutions : enzymes digestives, trempage des ol√©agineux, m√¢cher plus, etc.
- Lie digestion et absorption des nutriments
- Minimum 40-45 lignes
- Score bas√© sur la sant√© digestive
`,

  "Axes hormonaux & bilans": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "AXES HORMONAUX & BILANS" :
- Insiste sur l'IMPORTANCE CRITIQUE d'un bilan sanguin
- Liste TOUS les marqueurs √† analyser : testost√©rone totale/libre, SHBG, cortisol, insuline √† jeun, TSH/T3/T4, vitamine D, profil lipidique
- Pour CHAQUE marqueur : explique ce qu'il mesure, les valeurs optimales, ce qu'un d√©s√©quilibre cause
- Relie ses sympt√¥mes actuels (plateau, stockage abdominal) aux hypoth√®ses hormonales
- Donne les fourchettes PR√âCISES (pas juste "normal" mais les chiffres)
- Minimum 50-55 lignes tr√®s techniques
- Score bas√© sur le niveau de donn√©es disponibles (bas s'il n'a pas fait de bilan)
`,

  "Moment R√©v√©lation": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "MOMENT R√âV√âLATION" :
- R√©dige UN SEUL paragraphe COURT (4-6 phrases max), PERCUTANT, TRANSFORMATIONNEL
- C'est LE moment o√π tout s'√©claire pour le client
- R√©v√®le la VRAIE raison de son blocage en connectant tous les √©l√©ments
- Format type : "Voil√† ce que personne ne t'a jamais dit..."
- Ton : r√©v√©lation, prise de conscience brutale mais bienveillante
- PAS de liste, PAS de score, PAS de d√©veloppement long
- DIRECT et IMPACTANT - phrases courtes et percutantes
`,

  "Cause Racine en 3 phrases": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "CAUSE RACINE EN 3 PHRASES" :
- R√©dige EXACTEMENT 3 phrases courtes et ULTRA SIMPLES
- Chaque phrase = 1 ligne maximum
- Format type :
  Phrase 1: "Tu ne manques pas de [ce qu'il pense √™tre le probl√®me]."
  Phrase 2: "C'est [CAUSE PR√âCISE bas√©e sur les vraies donn√©es] qui cr√©ent le plateau."
  Phrase 3: "Quand on d√©bloque √ßa, ton corps repart."
- ULTRA LISIBLE, ULTRA CLAIR
- Le client doit comprendre en 5 secondes
- PAS de paragraphes longs, PAS de d√©veloppement
`,

  "Radar Profil actuel et Profil optimis√©": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "RADAR PROFIL ACTUEL ET PROFIL OPTIMIS√â" :
- NE JAMAIS r√©p√©ter le titre de la section dans le contenu
- Commence DIRECTEMENT par le contenu visuel
- Cr√©e un GRAPHIQUE RADAR ASCII tr√®s visuel avec les 8 dimensions
- Les 8 dimensions OBLIGATOIRES : Stress / M√©tabolisme / Hormones / Sommeil / Entra√Ænement / Digestion / Biom√©canique / √ânergie
- Format OBLIGATOIRE pour le graphique ASCII :

üìä PROFIL ACTUEL :
           Stress [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°] 6/10
       M√©tabolisme [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°] 5/10
         Hormones [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°] 5/10
          Sommeil [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°] 4/10
     Entra√Ænement [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°] 7/10
        Digestion [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°] 6/10
     Biom√©canique [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°] 7/10
          √ânergie [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°] 6/10

- Ensuite explique bri√®vement chaque dimension
- Puis montre le PROFIL OPTIMIS√â (90 jours) au m√™me format ASCII
- Montre le GAP pour d√©clencher l'achat
- PAS de score global pour cette section
`,

  "Ton Potentiel Inexploit√©": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "TON POTENTIEL INEXPLOIT√â" :
- NE JAMAIS r√©p√©ter le titre dans le contenu
- Commence DIRECTEMENT par une JAUGE TEXTUELLE visuelle de 0% √† 100%
- Format obligatoire :
  "Jauge de Potentiel : [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°] 40%"
- Explique o√π le client se situe AUJOURD'HUI (bas√© sur vraies donn√©es)
- Puis d√©cris VISUELLEMENT ce que repr√©sente chaque palier :

  +20% [‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°]
  ‚Üí Changements concrets : [liste 2-3 b√©n√©fices]

  +40% [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°]
  ‚Üí Transformation visible : [liste 2-3 b√©n√©fices]

  +60% [‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°]
  ‚Üí Niveau √©lite : [liste 2-3 b√©n√©fices]

- Personnalis√© selon SON profil
- PAS de score global
- Cr√©e l'envie d'exploiter ce potentiel cach√©
`,

  "Feuille de Route en 6 Points": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "FEUILLE DE ROUTE EN 6 POINTS" :
- Structure OBLIGATOIRE en EXACTEMENT 6 points num√©rot√©s :
  1Ô∏è‚É£ Correction nerveuse & sommeil
  2Ô∏è‚É£ Optimisation hormonale naturelle
  3Ô∏è‚É£ Reprogrammation m√©tabolique
  4Ô∏è‚É£ Strat√©gie nutritionnelle personnalis√©e
  5Ô∏è‚É£ Plan d'entra√Ænement calibr√© selon biom√©canique
  6Ô∏è‚É£ Routine anti-inflammation & r√©cup√©ration
- Pour CHAQUE point : 4-6 lignes expliquant PR√âCIS√âMENT comment tu vas l'appliquer √Ä CE CLIENT
- Bas√© sur ses VRAIES donn√©es (pas de g√©n√©rique!)
- Format clair, num√©rot√©, actionnable
- Minimum 35-40 lignes au total
`,

  "Projection 30/60/90 jours": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "PROJECTION 30/60/90 JOURS" :
- NE JAMAIS r√©p√©ter le titre dans le contenu
- Format OBLIGATOIRE - 3 sections avec D√âTAILS :

üóìÔ∏è DANS 30 JOURS (4 semaines) :
[4-5 changements concrets et mesurables]

üóìÔ∏è DANS 60 JOURS (8 semaines) :
[4-5 transformations majeures]

üóìÔ∏è DANS 90 JOURS (12 semaines) :
[4-5 r√©sultats finaux - transformation compl√®te]

- Utilise les √©mojis üóìÔ∏è pour chaque palier
- Projections R√âALISTES et PERSONNALIS√âES (bas√©es sur SES vraies donn√©es)
- Le client doit SE VOIR √©voluer concr√®tement
- Inclure : poids, % gras, force, √©nergie, visuel, confiance
- PAS de score
- Minimum 25-30 lignes
`,

  "Ce qui va changer si on travaille ensemble": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "CE QUI VA CHANGER SI ON TRAVAILLE ENSEMBLE" :
- Structure en DEUX parties : AUJOURD'HUI vs DANS 90 JOURS
- AUJOURD'HUI : d√©cris sa r√©alit√© actuelle (frustration, questions, doutes)
- DANS 90 JOURS : d√©cris sa vie transform√©e (physique, mental, confiance)
- Tr√®s CONCRET, tr√®s HUMAIN, tr√®s √âMOTIONNEL
- Le client doit se VOIR dans le futur
- Parle de SA vie, SON quotidien, SES blocages sp√©cifiques
- Cr√©e le lien √©motionnel et l'envie d'acheter
- Minimum 30-35 lignes
- Pas de score
`,

  "R√©assurance √©motionnelle": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "R√âASSURANCE √âMOTIONNELLE" :
- Le client doit sentir :
  ‚úì Qu'il n'a pas "√©chou√©"
  ‚úì Qu'il n'est pas en √©chec
  ‚úì Que ce qu'il vit est NORMAL et EXPLICABLE
  ‚úì Qu'il y a une LOGIQUE √† tout √ßa
  ‚úì Que TU MA√éTRISES la situation et tu peux l'aider
- Ton chaleureux, proche, expert mais empathique
- Rassure sans √™tre condescendant
- Montre que tu COMPRENDS vraiment sa situation
- Valorise ses EFFORTS d√©j√† fournis
- Bas√© sur ses vraies donn√©es (r√©assurance personnalis√©e)
- Minimum 25-30 lignes
- Pas de score
`,

  "Synth√®se clinique globale et Conclusion transformationnelle": `
üìå INSTRUCTIONS SP√âCIFIQUES POUR "SYNTH√àSE CLINIQUE GLOBALE" :
- R√âCAPITULE tout l'audit de mani√®re structur√©e :
  ‚óÜ FORCES MAJEURES : liste ses points forts (5-6 points)
  ‚óÜ AXES D'OPTIMISATION : liste les corrections √† faire (6-8 points)
  ‚óÜ RISQUES SI RIEN NE CHANGE : ce qui va se passer s'il ne fait rien
  ‚óÜ POTENTIEL R√âEL : ce qu'il peut atteindre avec le bon accompagnement
  ‚óÜ TON ENGAGEMENT : ce que tu lui promets si vous travaillez ensemble
- Conclusion puissante qui pousse √† l'action
- Minimum 40-45 lignes
- Score final bas√© sur l'ensemble du profil
`
};

// ============================================================
// PROMPT TEASER (pour sections bloqu√©es en version FREE)
// ============================================================
const PROMPT_TEASER = `Tu es Achzod. G√©n√®re un TEASER de 3-4 lignes pour cette section : {section}

Le teaser doit :
- Montrer que tu as ANALYS√â ses donn√©es (cite 1-2 √©l√©ments sp√©cifiques)
- Cr√©er de la CURIOSIT√â (qu'est-ce qu'il va d√©couvrir ?)
- Terminer par "üîì D√©bloque l'analyse compl√®te pour d√©couvrir..."
- Maximum 4 lignes, ton accrocheur

Donn√©es client :
{data}
`;

// ============================================================
// FONCTION APPEL GEMINI
// ============================================================
async function callGemini(prompt: string): Promise<string> {
  const model = genAI.getGenerativeModel({ model: CONFIG.GEMINI_MODEL });

  for (let attempt = 0; attempt < CONFIG.GEMINI_MAX_RETRIES; attempt++) {
    try {
      const result = await model.generateContent({
        contents: [{ role: 'user', parts: [{ text: prompt }] }],
        generationConfig: {
          temperature: CONFIG.GEMINI_TEMPERATURE,
          maxOutputTokens: CONFIG.GEMINI_MAX_TOKENS,
        },
      });
      return result.response.text();
    } catch (error: any) {
      console.log(`‚ö†Ô∏è Gemini erreur (${attempt + 1}/${CONFIG.GEMINI_MAX_RETRIES}): ${error.message}`);
      if (attempt < CONFIG.GEMINI_MAX_RETRIES - 1) {
        await new Promise(r => setTimeout(r, CONFIG.GEMINI_SLEEP_BETWEEN * (attempt + 1) * 1000));
      }
    }
  }
  return "";
}

// ============================================================
// NETTOYAGE MARKDOWN
// ============================================================
function cleanMarkdown(text: string): string {
  return text
    .replace(/\*\*/g, '')
    .replace(/##/g, '')
    .replace(/__/g, '')
    .replace(/\*/g, '');
}

// ============================================================
// D√âTERMINER LE STATUT D'UNE SECTION SELON LE TIER
// ============================================================
function getSectionStatus(section: string, tier: AuditTier): { isUnlocked: boolean; isTeaser: boolean } {
  if (tier === 'PREMIUM' || tier === 'ELITE') {
    return { isUnlocked: true, isTeaser: false };
  }

  const freeTier = AUDIT_TIERS.FREE;
  
  if (freeTier.sectionsUnlocked.includes(section)) {
    return { isUnlocked: true, isTeaser: false };
  }
  
  if (freeTier.sectionsTeaser.includes(section)) {
    return { isUnlocked: false, isTeaser: true };
  }
  
  return { isUnlocked: false, isTeaser: false };
}

// ============================================================
// G√âN√âRER UNE SECTION
// ============================================================
async function generateSection(
  section: SectionName,
  clientData: ClientData,
  photoAnalysis: PhotoAnalysis | null,
  tier: AuditTier
): Promise<AuditSection> {
  const { isUnlocked, isTeaser } = getSectionStatus(section, tier);

  // Pr√©parer les donn√©es
  const dataStr = Object.entries(clientData)
    .filter(([_, v]) => v)
    .map(([k, v]) => `- ${k}: ${v}`)
    .join('\n');

  const photoStr = photoAnalysis?.available
    ? `\n\nANALYSE PHOTO DISPONIBLE:\n${JSON.stringify(photoAnalysis, null, 2)}`
    : '\n\nAUCUNE PHOTO FOURNIE.';

  const fullData = dataStr + photoStr;

  // Section compl√®te (d√©bloqu√©e)
  if (isUnlocked) {
    const instructions = SECTION_INSTRUCTIONS[section] || '';
    const prompt = PROMPT_SECTION
      .replace('{section}', section)
      .replace('{section_specific_instructions}', instructions)
      .replace('{data}', fullData);

    const content = await callGemini(prompt);
    const cleanContent = cleanMarkdown(content);

    // Extraire le score si pr√©sent
    const scoreMatch = cleanContent.match(/Score\s*:\s*(\d+(?:[.,]\d+)?)\s*\/\s*10/i);
    const score = scoreMatch ? parseFloat(scoreMatch[1].replace(',', '.')) : undefined;

    return {
      id: section.toLowerCase().replace(/[^a-z0-9]/g, '-'),
      title: section,
      content: cleanContent,
      score,
      isUnlocked: true,
      isTeaser: false
    };
  }

  // Section teaser (aper√ßu qui donne envie)
  if (isTeaser) {
    const prompt = PROMPT_TEASER
      .replace('{section}', section)
      .replace('{data}', fullData);

    const teaserContent = await callGemini(prompt);

    return {
      id: section.toLowerCase().replace(/[^a-z0-9]/g, '-'),
      title: section,
      content: '',
      isUnlocked: false,
      isTeaser: true,
      teaserPreview: cleanMarkdown(teaserContent)
    };
  }

  // Section compl√®tement bloqu√©e
  return {
    id: section.toLowerCase().replace(/[^a-z0-9]/g, '-'),
    title: section,
    content: '',
    isUnlocked: false,
    isTeaser: false,
    teaserPreview: `üîí Cette section est r√©serv√©e aux membres Premium.\n\nD√©couvre ton analyse ${section} compl√®te avec toutes les recommandations personnalis√©es.`
  };
}

// ============================================================
// G√âN√âRATION COMPL√àTE
// ============================================================
export async function generateAudit(
  clientData: ClientData,
  photoAnalysis: PhotoAnalysis | null,
  tier: AuditTier = 'FREE'
): Promise<AuditResult> {
  const startTime = Date.now();
  const clientName = `${clientData.prenom || 'Client'} ${clientData.nom || ''}`.trim();

  console.log(`\nüîÑ G√©n√©ration audit ${tier} pour ${clientName}...`);

  const sections: AuditSection[] = [];
  let fullTxt = `=== AUDIT COMPLET - ${clientName.toUpperCase()} ===\n`;

  for (let i = 0; i < SECTIONS.length; i++) {
    const section = SECTIONS[i];
    const { isUnlocked } = getSectionStatus(section, tier);

    process.stdout.write(`  [${i + 1}/${SECTIONS.length}] ${section}... `);

    const auditSection = await generateSection(section, clientData, photoAnalysis, tier);
    sections.push(auditSection);

    if (isUnlocked && auditSection.content) {
      fullTxt += `\n${'='.repeat(60)}\n${section.toUpperCase()}\n${'='.repeat(60)}\n`;
      fullTxt += auditSection.content;
    }

    console.log(isUnlocked ? '‚úì' : 'üîí');

    await new Promise(r => setTimeout(r, 2000));
  }

  // Calculer score global
  const scoredSections = sections.filter(s => s.score !== undefined);
  const globalScore = scoredSections.length > 0
    ? Math.round(scoredSections.reduce((acc, s) => acc + (s.score || 0), 0) / scoredSections.length * 10) / 10
    : undefined;

  return {
    success: true,
    tier,
    sections,
    fullTxt: tier !== 'FREE' ? fullTxt : undefined,
    clientName,
    globalScore,
    metadata: {
      generationTimeMs: Date.now() - startTime,
      sectionsGenerated: sections.filter(s => s.isUnlocked).length,
      modelUsed: CONFIG.GEMINI_MODEL
    }
  };
}

export { SECTIONS, callGemini };


==========================================
FICHIER 4: server/index.ts
==========================================

/**
 * NEUROCORE 360 - Serveur Express
 */

import express from 'express';
import cors from 'cors';
import { CONFIG, AUDIT_TIERS } from './config';
import { generateAudit } from './geminiPremiumEngine';
import { ClientData, PhotoAnalysis, AuditTier } from './types';

const app = express();

app.use(cors());
app.use(express.json({ limit: '50mb' }));

// Health check
app.get('/api/health', (req, res) => {
  res.json({
    status: 'OK',
    service: 'NEUROCORE 360',
    gemini: { model: CONFIG.GEMINI_MODEL, ready: true },
    tiers: Object.keys(AUDIT_TIERS)
  });
});

// G√©n√©ration audit
app.post('/api/generate-audit', async (req, res) => {
  try {
    const { clientData, photoAnalysis, tier = 'FREE' } = req.body as {
      clientData: ClientData;
      photoAnalysis?: PhotoAnalysis | null;
      tier?: AuditTier;
    };

    if (!clientData) {
      return res.status(400).json({ success: false, error: 'clientData requis' });
    }

    const result = await generateAudit(clientData, photoAnalysis || null, tier);
    res.json(result);
  } catch (error: any) {
    console.error('‚ùå Erreur:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// Info tiers
app.get('/api/tiers', (req, res) => {
  res.json(AUDIT_TIERS);
});

const PORT = CONFIG.PORT;
app.listen(PORT, () => {
  console.log(`\nüöÄ NEUROCORE 360 sur port ${PORT}`);
  console.log(`üìä Gemini: ${CONFIG.GEMINI_MODEL}`);
  console.log(`üîë API Key: ${CONFIG.GEMINI_API_KEY ? '‚úì' : '‚úó'}\n`);
});


==========================================
APR√àS CR√âATION DES FICHIERS :

1. npm install @google/generative-ai express cors dotenv
2. npm install -D typescript ts-node @types/node @types/express @types/cors
3. Cr√©er .env avec : GEMINI_API_KEY=AIzaSyCYpRQifyhMTFu-q0dihbomcOdB0eaogc4
4. npm run dev

==========================================