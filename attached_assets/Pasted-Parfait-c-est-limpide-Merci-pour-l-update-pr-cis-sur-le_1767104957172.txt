Parfait, c'est limpide ! Merci pour l'update prÃ©cis sur les IDs de modÃ¨les de 2025. C'est exactement ce qu'il me fallait pour finaliser l'intÃ©gration sans deviner.
Je vais mettre Ã  jour immÃ©diatement le code avec les IDs exacts que tu m'as donnÃ©s.
Je vais utiliser :
claude-sonnet-4-5-20250929 comme moteur principal pour la gÃ©nÃ©ration des rapports et protocoles (le "cerveau" Ã©quilibrÃ© et puissant).
Pour l'analyse photo, je vais aussi utiliser Sonnet 4.5 (vu sa puissance, sa vision doit Ãªtre excellente), sauf si tu prÃ©fÃ¨res Opus 4.1 pour la vision pure. Mais Sonnet 4.5 est souvent supÃ©rieur aux anciens Opus.
Je mets Ã  jour les deux fichiers. Copie-les maintenant, c'est la version finale optimisÃ©e pour ton API.
1. server/photoAnalysisAI.ts (Vision avec Sonnet 4.5)
photoAnalysisAI.ts
import Anthropic from "@anthropic-ai/sdk";// --- CONFIGURATION MODÃˆLE 2025 ---// Utilisation de Claude Sonnet 4.5 pour l'analyse visuelle (Vision & Raisonnement Rapide)const AI_MODEL = "claude-sonnet-4-5-20250929";const anthropic = new Anthropic({  apiKey: process.env.AI_INTEGRATIONS_ANTHROPIC_API_KEY,  baseURL: process.env.AI_INTEGRATIONS_ANTHROPIC_BASE_URL,});export interface PhotoAnalysisResult {  fatDistribution: {    visceral: "faible" | "modere" | "eleve" | "tres-eleve";    subcutaneous: "faible" | "modere" | "eleve" | "tres-eleve";    zones: string[];    estimatedBF: string;    waistToHipRatio: string;  };  posture: {    headPosition: string;    shoulderAlignment: string;    spineAlignment: string;    pelvicTilt: string;    kneesAlignment: string;    overallScore: number;    issues: string[];  };  muscularBalance: {    upperBody: string;    lowerBody: string;    leftRightSymmetry: string;    anteriorPosterior: string;    weakAreas: string[];    strongAreas: string[];  };  medicalObservations: {    skinCondition: string[];    edemaPresence: string;    vascularSigns: string[];    potentialConcerns: string[];  };  recommendations: {    posturalCorrections: string[];    muscleGroupsToTarget: string[];    mobilityWork: string[];    medicalFollowUp: string[];  };  summary: string;  confidenceLevel: number;}export const PHOTO_ANALYSIS_PROMPT = `Tu es un Expert KinÃ©sithÃ©rapeute, Coach Ã‰lite et SpÃ©cialiste en Analyse Morpho-Anatomique.Ta mission est d'effectuer une analyse visuelle STRICTE et APPROFONDIE des photos fournies.RÃˆGLE D'OR : TU DOIS TE BASER UNIQUEMENT SUR CE QUE TU VOIS SUR LES PHOTOS. N'INVENTE RIEN. NE SUPPOSE RIEN BASÃ‰ SUR DES STATISTIQUES GÃ‰NÃ‰RALES. SI TU NE VOIS PAS, DIS QUE C'EST NON VISIBLE.Analyse chaque dÃ©tail :1. Distribution des graisses : Regarde prÃ©cisÃ©ment oÃ¹ le gras est stockÃ© (ventre, hanches, cuisses, bras). Estime le BF% VISUELLEMENT.2. Posture : Trace des lignes imaginaires. La tÃªte est-elle en avant ? Les Ã©paules enroulÃ©es ? Le bassin basculÃ© ? Valgus/Varus aux genoux ?3. Ã‰quilibre musculaire : Compare gauche/droite et haut/bas. Identifie les muscles sous-dÃ©veloppÃ©s ou dominants.4. Signes mÃ©dicaux visibles : Varices, Å“dÃ¨mes, qualitÃ© de peau, cicatrices, vergetures (indiquant une prise/perte rapide).Ton analyse doit Ãªtre CRITIQUE et SANS FILTRE. Le but est d'identifier les vrais problÃ¨mes pour corriger le physique.Reponds UNIQUEMENT avec ce JSON (pas de texte avant/aprÃ¨s, pas de markdown) :{  "fatDistribution": {    "visceral": "faible|modere|eleve|tres-eleve",    "subcutaneous": "faible|modere|eleve|tres-eleve",    "zones": ["liste prÃ©cise des zones de stockage visibles"],    "estimatedBF": "XX-YY%",    "waistToHipRatio": "estimation visuelle (ex: >0.9 ou <0.8)"  },  "posture": {    "headPosition": "description prÃ©cise (ex: protraction marquÃ©e)",    "shoulderAlignment": "description prÃ©cise (ex: Ã©paule droite plus basse)",    "spineAlignment": "description prÃ©cise (ex: hyperlordose lombaire visible)",    "pelvicTilt": "description prÃ©cise (ex: antÃ©version)",    "kneesAlignment": "description prÃ©cise (ex: valgus lÃ©ger Ã  gauche)",    "overallScore": 1-10,    "issues": ["liste des dÃ©sÃ©quilibres posturaux majeurs"]  },  "muscularBalance": {    "upperBody": "description dÃ©veloppement",    "lowerBody": "description dÃ©veloppement",    "leftRightSymmetry": "analyse symÃ©trie",    "anteriorPosterior": "analyse chaÃ®ne ant/post",    "weakAreas": ["muscles en retard"],    "strongAreas": ["points forts"]  },  "medicalObservations": {    "skinCondition": ["observations"],    "edemaPresence": "oui/non et localisation",    "vascularSigns": ["varicositÃ©s, veines apparentes..."],    "potentialConcerns": ["points de vigilance santÃ© visibles"]  },  "recommendations": {    "posturalCorrections": ["exercices correctifs spÃ©cifiques"],    "muscleGroupsToTarget": ["prioritÃ©s hypertrophie/renforcement"],    "mobilityWork": ["zones Ã  assouplir"],    "medicalFollowUp": ["si nÃ©cessaire"]  },  "summary": "SynthÃ¨se globale de l'analyse physique (max 3 phrases)",  "confidenceLevel": 1-10}`;export async function analyzeBodyPhotosWithAI(photoUrls: string[]): Promise<PhotoAnalysisResult> {  console.log(`DÃ©but analyse photo AI (${AI_MODEL}) pour ${photoUrls.length} images...`);    if (!photoUrls || photoUrls.length === 0) {    throw new Error("Aucune photo fournie pour l'analyse.");  }  const content: any[] = [{ type: "text", text: PHOTO_ANALYSIS_PROMPT }];  for (const url of photoUrls) {    try {        console.log(`TÃ©lÃ©chargement image: ${url.substring(0, 50)}...`);        const response = await fetch(url);        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);                const arrayBuffer = await response.arrayBuffer();        const buffer = Buffer.from(arrayBuffer);        const base64 = buffer.toString('base64');        const mediaType = response.headers.get('content-type') || "image/jpeg";                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];        const finalMediaType = validTypes.includes(mediaType) ? mediaType : 'image/jpeg';        content.push({            type: "image",            source: {                type: "base64",                media_type: finalMediaType,                data: base64            }        });    } catch (e) {        console.error(`Erreur lors du traitement de l'image ${url}:`, e);    }  }  if (content.length === 1) {     throw new Error("Impossible de charger les images pour l'analyse.");  }  try {    const msg = await anthropic.messages.create({      model: AI_MODEL,      max_tokens: 3000,      messages: [{ role: "user", content: content }]    });    const contentResponse = msg.content[0].type === 'text' ? msg.content[0].text : "";    console.log("RÃ©ponse brute analyse photo:", contentResponse.substring(0, 200) + "...");    const jsonMatch = contentResponse.match(/\{[\s\S]*\}/);    if (!jsonMatch) {      throw new Error("Pas de JSON valide trouvÃ© dans la rÃ©ponse");    }    return JSON.parse(jsonMatch[0]) as PhotoAnalysisResult;  } catch (error) {    console.error("Erreur API Anthropic (Vision):", error);    throw error;  }}
2. server/narrativeEngineAI.ts (Moteur Protocoles avec Sonnet 4.5)
narrativeEngineAI.ts
import Anthropic from "@anthropic-ai/sdk";import { getAllResponsesFormatted } from "./responsePreprocessor";import { analyzeBodyPhotosWithAI, PhotoAnalysisResult } from "./photoAnalysisAI";import { SAFETY_GATES, IHERB_RULES, SUPPLEMENT_LIBRARY } from "./expertProtocols";// --- CONFIGURATION MODÃˆLE 2025 ---// Utilisation de Claude Sonnet 4.5 pour la gÃ©nÃ©ration complexe (Rapport & Protocoles)const AI_MODEL = "claude-sonnet-4-5-20250929";const anthropic = new Anthropic({  apiKey: process.env.AI_INTEGRATIONS_ANTHROPIC_API_KEY,  baseURL: process.env.AI_INTEGRATIONS_ANTHROPIC_BASE_URL,});const SYSTEM_PROMPT = `You are â€œAchzod Supplement Engineâ€: an evidence-weighted, safety-first supplement recommendation system for iHerb-buyable products.GOAL- Build domain-specific supplement stacks (cardio, joints, lower estrogen, lower cortisol, increase testosterone, sleep, neurotransmitter/cognition/mood).- Output MUST be strict JSON matching the provided schema.- Recommendations must be individualized based on user inputs.- Prioritize: safety > evidence > fit > simplicity > cost.- Avoid â€œbro-scienceâ€ claims. If evidence is weak, label it clearly.- Never recommend prescription drugs, SARMs, prohormones, or illegal substances.- If the user is on TRT/AAS, explicitly adapt: do NOT â€œcrash estrogenâ€; include red flags and suggest labs/medical supervision.CORE RULES (Applied from library):1) Use â€œminimal effective stackâ€: no more than 8 core items per domain.2) Dosing: Prefer evidence-based fixed dosing. Scale by BW where relevant.3) Safety gates: Check anticoagulants, SSRIs, Liver disease constraints.4) Evidence labeling: Grade A/B/C/D.5) iHerb purchase logic: Never hallucinate. Look for standardizations (e.g., eurycomanone %, withanolides %).OUTPUT JSON ONLY. NO MARKDOWN.`;export async function generateNarrativeReport(responses: any, photoUrls: string[] = []) {  console.log(`GÃ©nÃ©ration Audit Premium V3 (Engine: Achzod Supplement Engine / Model: ${AI_MODEL})...`);  // 1. Analyse Photo  let photoAnalysisResult: PhotoAnalysisResult | null = null;  if (photoUrls && photoUrls.length > 0) {    try {      photoAnalysisResult = await analyzeBodyPhotosWithAI(photoUrls);    } catch (error) {      console.error("Erreur analyse photo:", error);    }  }  // 2. Contexte Utilisateur enrichi  const userProfile = getAllResponsesFormatted(responses);  const expertContext = {    safety_gates: SAFETY_GATES,    iherb_rules: IHERB_RULES,    library_snapshot: SUPPLEMENT_LIBRARY  };  const fullPrompt = `    USER PROFILE:    ${userProfile}    PHOTO ANALYSIS (PRIORITY - VISUAL TRUTH):    ${photoAnalysisResult ? JSON.stringify(photoAnalysisResult) : "No photos provided."}    EXPERT KNOWLEDGE BASE INJECTION:    ${JSON.stringify(expertContext)}    GENERATE FULL AUDIT JSON NOW MATCHING THE "AchzodSupplementEngineOutput" SCHEMA.    BE BRUTALLY HONEST ON VISUAL ANALYSIS AND PRECISE ON DOSAGES.  `;  try {    const msg = await anthropic.messages.create({      model: AI_MODEL,      max_tokens: 4000,      temperature: 0.4,       system: SYSTEM_PROMPT,      messages: [        { role: "user", content: fullPrompt }      ]    });    const content = msg.content[0].type === 'text' ? msg.content[0].text : "";        // Extraction et validation JSON    const jsonMatch = content.match(/\{[\s\S]*\}/);    if (!jsonMatch) throw new Error("No JSON found");    return JSON.parse(jsonMatch[0]);  } catch (e) {    console.error("Critical Engine Error:", e);    throw new Error("Failed to generate valid JSON audit.");  }}
C'est prÃªt. Colle Ã§a, et ton moteur tourne en 2025 avec la puissance de Sonnet 4.5. ðŸš€