import{u as B,r as n,j as e,bx as E,aV as h,aO as v,B as R,aG as _,by as k,aU as w,aR as D}from"./vendor-C1l_5e97.js";import{u as $,H as M,F as P}from"./index-Cv9frRJP.js";import{B as f}from"./button-DpFebx5z.js";import{C as b,c as A,a as U}from"./card-CFv6635F.js";import{B as C}from"./badge-wSxm0MMJ.js";const Y={DISCOVERY:"Discovery Scan",ANABOLIC_BIOSCAN:"Anabolic Bioscan",ULTIMATE_SCAN:"Ultimate Scan",BLOOD_ANALYSIS:"Blood Analysis"},m={DISCOVERY:{code:"DISCOVERY20",description:"-20% coaching"},ANABOLIC_BIOSCAN:{code:"ANABOLICBIOSCAN",description:"59€ deduits"},ULTIMATE_SCAN:{code:"ULTIMATESCAN",description:"79€ deduits"},BLOOD_ANALYSIS:{code:"BLOOD",description:"99€ deduits"}};function G(){const[,j]=B(),[t]=n.useState(()=>sessionStorage.getItem("admin_key")||void 0||""),y=sessionStorage.getItem("admin_auth")==="true",[r,p]=n.useState([]),[u,x]=n.useState(!0),[d,c]=n.useState(null),{toast:i}=$(),N=async()=>{if(!y||!t){x(!1),j("/admin");return}x(!0);try{const s=await fetch("/api/admin/reviews/pending",{headers:{"x-admin-key":t}}),a=await s.json();if(s.status===401){sessionStorage.removeItem("admin_auth"),sessionStorage.removeItem("admin_key"),i({title:"Clé admin invalide",description:"Reconnecte-toi avec la bonne clé.",variant:"destructive"}),j("/admin");return}if(a.success)p(a.reviews);else throw new Error((a==null?void 0:a.error)||"Acces admin refuse")}catch{i({title:"Erreur",description:"Impossible de charger les avis",variant:"destructive"})}finally{x(!1)}};n.useEffect(()=>{N()},[t,y]);const S=async s=>{if(!t)return;const a=r.find(o=>o.id===s);c(s);try{if((await(await fetch(`/api/admin/reviews/${s}/approve`,{method:"POST",headers:{"Content-Type":"application/json","x-admin-key":t},body:JSON.stringify({reviewedBy:"admin"})})).json()).success){p(L=>L.filter(T=>T.id!==s));const l=a?m[a.auditType]:null;i({title:"Avis approuve",description:l?`Code promo ${l.code} envoye a ${a==null?void 0:a.email}`:"L'avis sera affiche sur le site"})}}catch{i({title:"Erreur",description:"Impossible d'approuver l'avis",variant:"destructive"})}finally{c(null)}},O=async s=>{if(t){c(s);try{(await(await fetch(`/api/admin/reviews/${s}/reject`,{method:"POST",headers:{"Content-Type":"application/json","x-admin-key":t},body:JSON.stringify({reviewedBy:"admin"})})).json()).success&&(p(g=>g.filter(l=>l.id!==s)),i({title:"Avis rejete",description:"L'avis ne sera pas affiche"}))}catch{i({title:"Erreur",description:"Impossible de rejeter l'avis",variant:"destructive"})}finally{c(null)}}},I=s=>e.jsx("div",{className:"flex gap-0.5",children:[1,2,3,4,5].map(a=>e.jsx(D,{className:`w-4 h-4 ${a<=s?"fill-yellow-400 text-yellow-400":"text-muted-foreground/30"}`},a))});return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(M,{}),e.jsxs("div",{className:"container max-w-4xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Moderation des Avis"}),e.jsxs("p",{className:"text-muted-foreground mt-1",children:[r.length," avis en attente de validation"]})]}),e.jsxs(f,{variant:"outline",onClick:N,disabled:u,"data-testid":"button-refresh-reviews",children:[e.jsx(E,{className:`w-4 h-4 mr-2 ${u?"animate-spin":""}`}),"Actualiser"]})]}),u?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(h,{className:"w-8 h-8 animate-spin text-primary"})}):r.length===0?e.jsx(b,{children:e.jsxs(A,{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(v,{className:"w-12 h-12 text-primary mb-4"}),e.jsx("h3",{className:"text-xl font-semibold",children:"Aucun avis en attente"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Tous les avis ont ete moderes"})]})}):e.jsx("div",{className:"space-y-4",children:r.map((s,a)=>e.jsx(R.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:a*.1},children:e.jsxs(b,{"data-testid":`card-review-${s.id}`,children:[e.jsx(U,{className:"pb-3",children:e.jsx("div",{className:"flex items-start justify-between gap-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[I(s.rating),e.jsxs(C,{variant:"outline",children:[e.jsx(_,{className:"w-3 h-3 mr-1"}),"En attente"]}),e.jsx(C,{variant:"secondary",children:Y[s.auditType]||s.auditType})]}),e.jsx("p",{className:"text-sm font-medium",children:s.email}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Audit: ",s.auditId.substring(0,8),"... |"," ",new Date(s.createdAt).toLocaleDateString("fr-FR")]})]})})}),e.jsxs(A,{children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[e.jsx(k,{className:"w-5 h-5 text-muted-foreground mt-0.5"}),e.jsx("p",{className:"text-base",children:s.comment})]}),m[s.auditType]&&e.jsxs("div",{className:"mb-4 p-3 rounded-lg bg-primary/5 border border-primary/20",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-primary",children:"Code promo:"})," ",e.jsx("code",{className:"font-mono bg-background px-1.5 py-0.5 rounded",children:m[s.auditType].code}),e.jsxs("span",{className:"text-muted-foreground ml-2",children:["(",m[s.auditType].description,")"]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Ce code sera envoye automatiquement a ",s.email," apres approbation"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(f,{onClick:()=>S(s.id),disabled:d===s.id,className:"flex-1","data-testid":`button-approve-${s.id}`,children:[d===s.id?e.jsx(h,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(v,{className:"w-4 h-4 mr-2"}),"Approuver + Envoyer code"]}),e.jsxs(f,{variant:"destructive",onClick:()=>O(s.id),disabled:d===s.id,className:"flex-1","data-testid":`button-reject-${s.id}`,children:[d===s.id?e.jsx(h,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(w,{className:"w-4 h-4 mr-2"}),"Rejeter"]})]})]})]})},s.id))})]}),e.jsx(P,{})]})}export{G as default};
